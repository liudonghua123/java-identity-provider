<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:c="http://www.springframework.org/schema/c"
    xmlns:p="http://www.springframework.org/schema/p"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd">

    <bean id="conversionService"
          class="org.springframework.context.support.ConversionServiceFactoryBean">
        <property name="converters">
            <set>
                <bean class="net.shibboleth.idp.attribute.resolver.spring.impl.StringToDurationConverter"/>
            </set>
        </property>
    </bean>

    <bean id="connectionFactory" class="org.ldaptive.PooledConnectionFactory" init-method="initialize"
          p:blockWaitTime="%{connectionPool.blockWaitTime}" p:failFastInitialize="%{connectionPool.failFastInitialize}" p:name="resolver-pool">
        <constructor-arg index="0">
            <bean class="org.ldaptive.ConnectionConfig" p:ldapUrl="%{connectionConfig.ldapURL}"
                  p:useStartTLS="%{connectionConfig.useStartTLS}"
                  p:connectTimeout="%{connectionConfig.connectTimeout}" p:responseTimeout="%{connectionConfig.responseTimeout}">
                <property name="connectionInitializers">
                    <bean class="org.ldaptive.BindConnectionInitializer" p:bindDn="%{connectionConfig.bindDn}"
                          p:bindCredential="%{connectionConfig.bindCredential}" />
                </property>
                <property name="sslConfig">
                    <bean class="org.ldaptive.ssl.SslConfig">
                        <property name="credentialConfig">
                            <bean class="org.ldaptive.ssl.X509CredentialConfig"
                                  p:trustCertificates="file:src/test/resources/net/shibboleth/idp/attribute/resolver/spring/dc/ldap/server.crt"
                                  p:authenticationCertificate="file:src/test/resources/net/shibboleth/idp/attribute/resolver/spring/dc/ldap/client.crt"
                                  p:authenticationKey="file:src/test/resources/net/shibboleth/idp/attribute/resolver/spring/dc/ldap/client.pkcs8" />
                        </property>
                    </bean>
                </property>
            </bean>
        </constructor-arg>
        <constructor-arg index="1">
            <bean class="org.ldaptive.pool.PoolConfig" p:minPoolSize="%{connectionPool.minPoolSize}"
                  p:maxPoolSize="%{connectionPool.maxPoolSize}" p:validatePeriodically="%{connectionPool.validatePeriodically}" />
        </constructor-arg>
        <property name="validator">
            <bean class="org.ldaptive.SearchConnectionValidator" p:validatePeriod="%{connectionPool.validatePeriod}">
                <property name="searchRequest">
                    <bean class="org.ldaptive.SearchRequest" c:_0="%{connectionPool.validator.baseDn}" c:_1="%{connectionPool.validator.filter}" />
                </property>
            </bean>
        </property>
        <property name="pruneStrategy">
            <bean class="org.ldaptive.pool.IdlePruneStrategy" p:prunePeriod="%{connectionPool.pruneStrategy.prunePeriod}"
                  p:idleTime="%{connectionPool.pruneStrategy.idleTime}" />
        </property>
    </bean>

    <bean class="org.ldaptive.SearchOperation">
        <property name="request">
            <bean class="org.ldaptive.SearchRequest" p:baseDn="%{search.baseDn}" p:returnAttributes="%{search.returnAttributes}" p:timeLimit="%{search.timeLimit}" />
        </property>
    </bean>
    <bean id="cacheBuilder" class="com.google.common.cache.CacheBuilder" factory-method="from">
        <constructor-arg value="%{cache.cacheBuilderSpec}" />
    </bean>
    <bean id="cache" class="com.google.common.cache.Cache" factory-bean="cacheBuilder" factory-method="build" />
    <bean class="net.shibboleth.idp.attribute.resolver.dc.ldap.impl.TemplatedExecutableSearchFilterBuilder"
        p:templateText="%{search.filter}" p:velocityEngine-ref="shibboleth.VelocityEngine"
        init-method="initialize" />
    <bean id="mappings" class="net.shibboleth.idp.attribute.resolver.dc.ldap.impl.StringAttributeValueMappingStrategy"
        p:noResultAnError="%{noResultIsError}" p:multipleResultsAnError="%{multipleResultsIsError}">
        <property name="resultRenamingMap">
            <map>
                <entry key="homephone" value="phonenumber" />
            </map>
        </property>
    </bean>
        <bean id="validator" class="net.shibboleth.idp.attribute.resolver.dc.ldap.impl.ConnectionFactoryValidator"
              p:connectionFactory-ref="connectionFactory" p:throwValidateError="true" />
    
</beans>
